# Gnosis Traceability System — Cursor Rules

You are implementing the Gnosis traceability system, a traceability-first verification engine.

## Mission Statement (Memorize This)

This system is NOT an oracle. It does NOT claim to know truth, understand meaning, or verify correctness in the abstract.

This system IS a traceability-first verification engine. Its purpose is to:
- Enforce end-to-end traceability from business requirements through implementation and tests
- Constrain change through explicit envelopes, ledgers, and immutability rules
- Issue only evidence-bounded judgments whose confidence is derived from measured alignment, not asserted understanding

## Strict Implementation Rules

### Rule 1: Spec Authority
- Read the COMPLETE spec file before writing ANY code
- Story specs are in `spec/track_a/stories/`
- Track-level specs (ENTRY, EXIT, PROMPTS) are in `spec/track_a/`
- SANITY suite is in `spec/00_pre_track_validation/`
- The spec is the ONLY authority — do not infer, extend, or "improve"

### Rule 2: Marker Requirements
- ALL files must have: `// @implements STORY-X.Y`
- ALL functions implementing ACs must have: `// @satisfies AC-X.Y.Z`
- Missing markers = incomplete implementation

### Rule 3: Database Access Boundary (G-API)
```
ARCHITECTURE LAYERS:
  scripts → ops → services → db
  (imports flow right-to-left; data flows left-to-right)

ALLOWED:
- src/db/** may be imported ONLY by src/services/**
- src/services/** may import from src/db/**
- src/api/v1/** may import from src/services/**
- src/ops/** may import from src/services/**
- Tests may import from @gnosis/api/v1 (functional) or src/ops/** (lifecycle only)
- Scripts may import from src/ops/**

FORBIDDEN:
- src/api/v1/** importing from src/db/**
- src/ops/** importing from src/db/**
- src/extraction/providers/** importing from src/db/** or src/services/**
- Tests importing from src/db/** or src/services/**
- Scripts importing from src/db/** or src/services/**

SCRIPTS BOUNDARY (Option A - Zero Exceptions):
- Scripts MAY import: src/ops/**, src/config/**, src/schema/**, pure utils
- Scripts MUST NOT import: src/services/**, src/db/**
- NO EXCEPTIONS. Even read-only queries must go through src/ops/** entrypoints.
- If ops layer lacks needed function, add it to ops first.
- Legacy exceptions: mark with @g-api-exception in JSDoc, document reason.
- Enforcement: npm run verify:scripts-boundary
```
Violation = HALT and fix immediately.

### Rule 4: Shadow Ledger Logging
- ALL entity creation → log to shadow ledger
- ALL relationship creation → log to shadow ledger
- ALL pipeline operations → log to shadow ledger
- No silent mutations

### Rule 5: Semantic Corpus
- Capture signals during extraction validation
- Signal types: CORRECT, INCORRECT, PARTIAL, ORPHAN_MARKER, AMBIGUOUS
- Minimum 50 signals during Track A

### Rule 6: No Inference
```
DO NOT:
- Infer entity types not in Epic 64
- Infer relationships not in UTG Schema
- Treat examples as suggestions
- Assume tests pass without running
- Silently resolve ambiguity
- Add "helpful" features not in ACs
- Optimize or refactor beyond spec
- Rename things for "clarity" if spec names them

DO:
- Implement EXACTLY as specified
- HALT and ask if ambiguous
- Reference exact AC numbers when claiming completion
- Run verification tests before marking complete
```

### Rule 7: Human Gates
At HGR-1 (end of Track A):
- Output: "HALT: Awaiting HGR-1 approval"
- Do NOT proceed on assumption
- Do NOT interpret lack of rejection as approval

### Rule 8: Organ Document Protection (RULE-NOAUTOFIX-001)

The six organ documents are **read-only during Cursor sessions** unless explicitly instructed by human with CID reference.

### Rule 9: Track A Lock Enforcement (RULE-TRACKA-LOCK-001)

Track A is **LOCKED** at baseline `track-a5-green` (SHA: `93ba7872885e1449004959eb8c79870da144f983`).

**Locked Surfaces (comprehensive — Option B):**
- `src/schema/track-a/**`
- `src/extraction/**`
- `src/services/entities/**`, `src/services/relationships/**`, `src/services/sync/**`
- `src/db/**`, `migrations/**`
- `src/markers/**`
- `src/ledger/**`
- `src/pipeline/**`, `src/ops/**`
- `src/api/v1/**`, `src/services/graph/**`, `src/http/**`
- `scripts/verification/**`
- `spec/track_a/**`
- `test/fixtures/**`
- `docs/verification/*LOCK_ATTESTATION*.md`, `docs/verification/*CLOSEOUT_PACKET*.md`, `docs/verification/HGR-*.md`

**FORBIDDEN without CID + REOPEN_TRACK_A: true:**
- Modifying any locked surface file
- Adding new files to locked surface paths
- Deleting files from locked surface paths

**If asked to modify a locked surface:**
1. **HALT** immediately
2. **REPORT:** "This would modify Track A locked surface: [file path]"
3. **REQUIRE:** User must provide CID reference containing `REOPEN_TRACK_A: true`
4. **VERIFY:** CID file exists in `docs/verification/`
5. **PROCEED:** Only with valid CID authorization

**CI Enforcement:** `scripts/verify-track-a-lock.ts` blocks PRs that modify locked surfaces without valid CID.

**Protected Files (Organ Docs):**
- `docs/BRD_*.md`
- `docs/UNIFIED_TRACEABILITY_GRAPH_SCHEMA_*.md`
- `docs/UNIFIED_VERIFICATION_SPECIFICATION_*.md`
- `docs/GNOSIS_TO_SOPHIA_MASTER_ROADMAP_*.md`
- `docs/CURSOR_IMPLEMENTATION_PLAN_*.md`
- `docs/integrations/EP-*.md`

**FORBIDDEN without explicit human instruction + CID:**
- Modifying any organ document
- "Fixing" version mismatches in organ docs
- "Correcting" counts, statistics, or cross-references
- Adding, removing, or rewording any organ doc content

**If you detect organ doc drift:**
1. REPORT the issue with specific file, line, current value, expected value
2. DO NOT apply the fix
3. Wait for human to provide CID reference before making changes

**If human requests organ doc change:**
1. Require CID reference (e.g., "CID-2025-001")
2. If no CID provided, respond: "Organ doc changes require a CID reference per RULE-NOAUTOFIX-001. Please provide CID or confirm this is a non-semantic fix."

Violation = HALT. Detection ≠ mutation.

## Canonical Documents (Read-Only Authority — See Rule 8)

These documents define truth. Do not contradict them. Do not modify them without CID.

| Document | Location | Purpose |
|----------|----------|---------|
| BRD | `docs/BRD_V20_6_4_COMPLETE.md` | Requirements source |
| UTG Schema | `docs/UNIFIED_TRACEABILITY_GRAPH_SCHEMA_V20_6_1.md` | Entity/relationship definitions |
| Verification Spec | `docs/UNIFIED_VERIFICATION_SPECIFICATION_V20_6_6.md` | Gates and test requirements |
| Roadmap | `docs/GNOSIS_TO_SOPHIA_MASTER_ROADMAP_V20_6_4.md` | Track sequencing |
| Cursor Plan | `docs/CURSOR_IMPLEMENTATION_PLAN_V20_8_5.md` | Implementation constraints |
| EP-D-002 | `docs/integrations/EP-D-002_RUNTIME_RECONCILIATION_V20_6_1.md` | Runtime (DORMANT until D.9) |

## Track A Entities (16 total — no others allowed)

E01 Epic, E02 Story, E03 AcceptanceCriterion, E04 Requirement,
E06 ArchitecturalDecision, E08 Component,
E11 SourceFile, E12 Function, E13 Class, E14 Interface, E15 Module,
E27 TestFile, E28 TestSuite, E29 TestCase,
E49 ReleaseVersion, E50 Commit

## Track A Relationships (24 total — no others allowed)

R01-R05 (Requirements), R10-R11 (Design), R21-R26 (Implementation),
R40-R45 (Verification), R60-R61 (Provenance)

## Forbidden References (DORMANT until Track D.9)

- Entities E84, E85 (ExecutionTrace, RuntimeCall)
- Relationships R113, R114 (TRACES_EXECUTION, RECONCILES_WITH)
- Gate G-RUNTIME

Referencing these = ERROR. Return `{ pass: true, skipped: true, reason: 'DORMANT' }` if tested.

## Story Implementation Pattern

For each story:

1. **Read** — Open and read the COMPLETE story card
2. **Check Entry** — Verify entry criteria are met
3. **Implement** — Build exactly what the spec says
4. **Mark** — Add @implements and @satisfies markers
5. **Log** — Ensure shadow ledger captures operations
6. **Test** — Run VERIFY-* tests from the story
7. **Confirm** — Check Definition of Done

## Verification Commands

```bash
npm run test:sanity          # Pre-track validation
npm run test -- --grep "X"   # Story-specific tests
npm run verify:gates         # Gate verification
npm run verify:integrity     # Graph integrity
npm run report:coverage      # Coverage report
npm run verify:organ-parity  # Organ doc version/count parity
```

## Error Recovery

If you hallucinate an entity/relationship:
→ STOP. Delete the code. Re-read the spec.

If G-API violation detected:
→ STOP. Remove direct DB import. Use @gnosis/api/v1.

If test fails:
→ Do NOT modify the test. Fix the implementation.

If ambiguous:
→ Do NOT guess. Output "AMBIGUITY: [description]" and HALT.

## BRD Counts (Must Match Exactly — V20.6.4)

- Epics: 65
- Stories: 397
- Acceptance Criteria: 3,147

Mismatch = extraction bug. Fix before proceeding.

## Remember

You are building infrastructure, not an oracle. Every claim must be evidence-bounded. Confidence ≠ truth. Alignment ≠ understanding.

When in doubt: read the spec, follow the spec, verify against the spec.

---

## TRACK STATE LOCK — TRACK A COMPLETE (A1–A5)

### Checkpoint Metadata

| Field | Value |
|-------|-------|
| **Phase** | TRACK A COMPLETE (A1–A5) |
| **Final Baseline Tag** | `track-a5-green` |
| **Final Baseline SHA** | `93ba7872885e1449004959eb8c79870da144f983` |
| **HGR-1 Original Tag** | `hgr-1-baseline` (A1–A3) |
| **HGR-1 Original SHA** | `9e2648a6d2940d93ce042c807476c6c951196e3b` |
| **Project ID** | `6df2f456-440d-4958-b475-d9808775ff69` |
| **HGR-1.1 Extension** | `docs/verification/HGR-1_1_EXTENSION_PACKET_2026-01-02.md` |
| **Governance Phase** | Phase 1 (hard-fail organ parity + CID enforcement) |

### Locked Invariants (HGR-1 Baseline)

These invariants were verified and MUST NOT drift:

1. **BRD counts (FROZEN):** E01=65, E02=397, E03=3147 — these never change
2. **Entity total:** ≥4424 (grows as extraction covers new source files)
3. **Relationship total:** ≥4408 (grows with extracted entities)
4. **Cross-store parity:** PostgreSQL = Neo4j (counts must match exactly)
5. **Neo4j property model:** Single `:RELATIONSHIP` type with `r.relationship_type` property
6. **Determinism:** Entity and relationship instance_ids are stable and reproducible
7. **Shadow ledger coverage:** 100% (epoch-scoped, per-project isolation)
8. **Evidence anchors:** All relationships have complete evidence
9. **Epoch fields:** All new ledger entries include epoch_id, repo_sha, runner_sha, brd_hash

### Locked Surfaces

**DO NOT MODIFY without explicit human instruction + re-verification:**

| Surface | Files |
|---------|-------|
| Entity extraction | `src/extraction/providers/ast-provider.ts`, `filesystem-provider.ts` |
| Relationship derivation | `src/extraction/providers/*-derivation-provider.ts`, `*-relationship-provider.ts` |
| Schema definitions | `src/schema/track-a/*` |
| Database migrations | `migrations/*.sql`, `migrations/neo4j/*` |
| Sync logic | `src/services/sync/sync-service.ts` |
| ID format rules | `src/schema/track-a/id-formats.ts` |
| Shadow ledger | `src/ledger/shadow-ledger.ts` |
| Service layer | `src/services/entities/`, `src/services/relationships/` |

### Lock Enforcement

**If a change request touches locked surfaces:**

1. **WARN:** "This would invalidate the HGR-1 baseline checkpoint (SHA: d6c2c9e2)."
2. **LIST:** Show which invariants may be affected.
3. **ASK:** "Confirm you want to proceed. Changes require re-running verification gates."
4. **PROCEED:** Only with explicit human confirmation.

**If you detect invariant drift during any operation:**

1. **HALT** immediately.
2. **REPORT:** "SI-readiness invariant violation detected: [specific invariant]"
3. **DO NOT** attempt to fix without human instruction.

### Verification Scripts

To re-verify after approved changes:

```bash
npx tsx scripts/si-readiness/verification-gates.ts     # All verification gates
npx tsx scripts/si-readiness/ledger-coverage-audit.ts  # Ledger coverage check
npx tsx scripts/run-foundation-validation.ts           # A1/A2 foundation checks
```

All must pass for checkpoint to remain valid.
