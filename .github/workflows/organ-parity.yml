name: Organ Parity

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

# Phase 1 Governance (activated 2026-01-02)
# See docs/GOVERNANCE_PHASED_PLAN.md

jobs:
  parity:
    runs-on: ubuntu-latest
    env:
      GOVERNANCE_PHASE: "1"   # Phase-1 hard-fail governance
      PROJECT_ID: 6df2f456-440d-4958-b475-d9808775ff69
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      NEO4J_URL: ${{ secrets.NEO4J_URL }}
      NEO4J_USER: ${{ secrets.NEO4J_USER }}
      NEO4J_PASSWORD: ${{ secrets.NEO4J_PASSWORD }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Required for diff-based checks

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Type check (non-emitting)
        run: npx tsc --noEmit

      # ------------------------------------------------------------
      # 1) Track A lock enforcement (CID-gated reopen)
      #    Blocks ANY change to Track A locked surfaces unless:
      #    - CID exists
      #    - CID contains REOPEN_TRACK_A: true
      # ------------------------------------------------------------
      - name: Fetch base branch (PR context)
        if: ${{ github.base_ref != '' }}
        run: git fetch origin ${{ github.base_ref }} --depth=1

      - name: Enforce Track A lock (CID-gated)
        env:
          GITHUB_BASE_REF: ${{ github.base_ref }}
          GITHUB_PR_TITLE: ${{ github.event.pull_request.title }}
          GITHUB_PR_BODY: ${{ github.event.pull_request.body }}
        run: npx tsx scripts/verify-track-a-lock.ts

      # ------------------------------------------------------------
      # 2) Organ document parity (Phase-1 hard fail)
      # ------------------------------------------------------------
      - name: Verify organ document parity
        run: npm run verify:organ-parity

      # ------------------------------------------------------------
      # 3) CID enforcement for organ document changes
      # ------------------------------------------------------------
      - name: Verify CID for organ doc changes
        env:
          GITHUB_BASE_REF: ${{ github.base_ref }}
          GITHUB_PR_TITLE: ${{ github.event.pull_request.title }}
          GITHUB_PR_BODY: ${{ github.event.pull_request.body }}
        run: npx tsx scripts/verify-cid-for-organ-changes.ts

      # ------------------------------------------------------------
      # 4) Scripts boundary enforcement (G-API)
      # ------------------------------------------------------------
      - name: Verify G-API scripts boundary
        run: npm run verify:scripts-boundary

      # ------------------------------------------------------------
      # 5) Prepare graph state (extraction + derivations)
      #    Ensures DB is consistent with repo state before tests
      # ------------------------------------------------------------
      - name: Prepare graph state (extraction + derivations)
        run: npx tsx scripts/run-a1-extraction.ts

      # ------------------------------------------------------------
      # 6) Write extraction provenance (Track B)
      #    Captures git SHA, environment, and graph state for B.3/B.4
      # ------------------------------------------------------------
      - name: Write extraction provenance (Track B)
        run: npx tsx scripts/track_b/write-extraction-provenance.ts

      # ------------------------------------------------------------
      # 7) Test suite (prevents silent regressions)
      # ------------------------------------------------------------
      - name: Run test suite
        run: npm test

      # ------------------------------------------------------------
      # 8) Upload Track B verification artifacts
      #    Preserves evidence for debugging and audit
      # ------------------------------------------------------------
      - name: Upload Track B verification artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: track-b-artifacts
          path: |
            docs/verification/track_b/**
